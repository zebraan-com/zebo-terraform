name: Terraform Platform

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply

jobs:
  terraform-platform:
    name: Platform Infrastructure
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: platform

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Write platform.tfvars from secrets
        run: |
          cat > platform.tfvars <<EOF
          project_id  = "${PROJECT_ID}"
          region      = "${REGION}"
          registry_id = "${REGISTRY_ID}"
          EOF
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: ${{ vars.GCP_REGION || 'asia-south1' }}
          REGISTRY_ID: ${{ vars.REGISTRY_ID || 'zebo-registry' }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Import Existing Resources
        run: |
          # Import existing resources if they exist (idempotent - won't fail if already imported)
          terraform import google_storage_bucket.terraform_state ${PROJECT_ID}-terraform-state 2>/dev/null || true
          terraform import google_service_account.terraform_ci projects/${PROJECT_ID}/serviceAccounts/terraform-ci@${PROJECT_ID}.iam.gserviceaccount.com 2>/dev/null || true
          terraform import google_service_account.gke_node_sa projects/${PROJECT_ID}/serviceAccounts/gke-node-sa@${PROJECT_ID}.iam.gserviceaccount.com 2>/dev/null || true
          terraform import module.artifact_registry.google_artifact_registry_repository.docker_repo projects/${PROJECT_ID}/locations/${REGION}/repositories/${REGISTRY_ID} 2>/dev/null || true
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: ${{ vars.GCP_REGION || 'asia-south1' }}
          REGISTRY_ID: ${{ vars.REGISTRY_ID || 'zebo-registry' }}
        continue-on-error: true

      - name: Terraform Fmt
        run: terraform fmt -check

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -input=false -var-file=platform.tfvars

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: terraform apply -input=false -auto-approve -var-file=platform.tfvars
